// deploy on linode with ~/deploymap.sh
function CVertexList(e){this.vertexBuffer=new ArrayBuffer(vertexListSize),this.totalSize=e,this.size=0,this.position=0,this.glBuffer=gl.createBuffer()}function finalizeVertexList(){if(currentVertexList!=-1){vertexListGLBuffers[currentVertexList]=gl.createBuffer();var e=new Float32Array(vertexLists[currentVertexList],0,currentVertexListPosition/4);gl.bindBuffer(gl.ARRAY_BUFFER,vertexListGLBuffers[currentVertexList]),gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW),vertexListGLBuffers[currentVertexList].itemSize=2,vertexListGLBuffers[currentVertexList].numItems=currentVertexListPosition/4}currentVertexList++,currentVertexListPosition=0,vertexLists[currentVertexList]=new ArrayBuffer(vertexListSize),vertexListSizes[currentVertexList]=currentVertexListPosition}function getVertexListFor(e){currentVertexList==-1&&finalizeVertexList(),currentVertexListPosition+e*4>vertexListSize&&finalizeVertexList();var t=currentVertexListPosition;return currentVertexListPosition+=e*4,t}function PixelsToWorld(e,t){var n=new THREE.Vector2,r=(e-SCREEN_WIDTH/2)*(worldWidth/SCREEN_WIDTH)/mapControls.scale+mapControls.x,i=-(t-SCREEN_HEIGHT/2)*(worldWidth/SCREEN_WIDTH)/mapControls.scale+mapControls.y;return new THREE.Vector2(r,i)}function haversineDistanceKM(e,t,n,r){var i=radians(n-e),s=radians(r-t),o=radians(e),u=radians(n);const a=Math.sin(i/2),f=Math.sin(s/2);var l=a*a+f*f*Math.cos(o)*Math.cos(u),c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return earthRadiusKM*c}function haversineDistanceABKM(e,t){return haversineDistanceKM(e.y,e.x,t.y,t.x)}function midpoint(e,t){var n=e.y,r=e.x,i=t.y,s=t.x,o=radians(i-n),u=radians(s-r),a=radians(n),f=radians(i),l=Math.cos(f)*Math.cos(u),c=Math.cos(f)*Math.sin(u),h=Math.atan2(Math.sin(a)+Math.sin(f),Math.sqrt((Math.cos(a)+l)*(Math.cos(a)+l)+c*c)),p=radians(r)+Math.atan2(c,Math.cos(a)+l);p=degrees(p),h=degrees(h);while(p<-180)p+=360;while(p>180)p-=360;return{x:p,y:h}}function radians(e){return e*Math.PI/180}function degrees(e){return e/(Math.PI/180)}function makeGreatCircle(e,t,n){var r=new THREE.Geometry;return r.vertices.push(new THREE.Vector3(e.x,e.y,0)),makeGreatCircleRecurse(e,t,r,n),r}function makeGreatCircleRecurse(e,t,n,r){if(haversineDistanceABKM(e,t)<=r)n.vertices.push(new THREE.Vector3(t.x,t.y,0));else{var i=midpoint(e,t);makeGreatCircleRecurse(e,i,n,r),makeGreatCircleRecurse(i,t,n,r)}}function fixWrappingGeometry(e){var t=e.vertices.length;if(t>0){var n=e.vertices[0];for(var r=1;r<t;r++)n.x<0&&e.vertices[r].x>0&&e.vertices[r].x-n.x>180?e.vertices[r].x-=360:n.x>0&&e.vertices[r].x<0&&n.x-e.vertices[r].x>180&&(e.vertices[r].x+=360),n=e.vertices[r]}}function init(){function o(e,t){return degrees(Math.atan(Math.cos(radians(e))/Math.tan(radians(t))))}$("#preview").hide();var e=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}}();if(!e){$("#loading-screen").hide(),$("#info").hide(),$("#info-nowebgl").show(),$("#time").hide();return}var t=mapControls.scale;container=document.createElement("div"),document.body.appendChild(container),scene=new THREE.Scene,terminatorScene=new THREE.Scene,camera2D=new THREE.OrthographicCamera(-100,100,100,-100,-150,4e3),camera2D.position.z=1e3,checkClock(),renderer=new THREE.WebGLRenderer({antialias:!0,clearColor:0,clearAlpha:1}),(!renderer||!renderer.getContext())&&$("info-nowebgl").show(),renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),renderer.domElement.style.position="relative",container.appendChild(renderer.domElement),renderer.autoClear=!1;var n=new THREE.PlaneGeometry(worldWidth,worldHeight),r=THREE.ImageUtils.loadTexture("../images/world.1920x960.jpg");r.anisotropy=renderer.getMaxAnisotropy();var i=new THREE.MeshBasicMaterial({map:r});i.depthTest=!1;var s=new THREE.Mesh(n,i);scene.add(s);var u=new Date(baseTime*1e3),a=u.getFullYear(),f=new Date(a-1,11,21),l=f.getTime()/1e3;console.log("solstice = "+f+" solsticeSeconds ="+l+" diff = "+(baseTime-l)),console.log("day ="+u.getDay());var c=(baseTime-l)/31536e3*360,h=Math.cos(radians(c))*-23.44;console.log("Declination = ",h);var p=1024,d=1024,v=new Uint8Array(p*d);for(var m=0;m<p;m++){var g=(m-p/2)/p*360,y=(o(g,h)+90)/180*d;for(var b=0;b<d;b++)b<y&&(v[m+b*p]=255)}var w=new THREE.PlaneGeometry(worldWidth,worldHeight),E=new THREE.DataTexture(v,p,d,THREE.AlphaFormat);E.needsUpdate=!0;var S=new THREE.MeshBasicMaterial({map:E,opacity:.7,transparent:!0});S.depthTest=!1,terminatorMesh1=new THREE.Mesh(w,S),terminatorMesh2=new THREE.Mesh(w,S),terminatorMesh2.position.x-=360,terminatorMesh3=new THREE.Mesh(w,S),terminatorMesh3.position.x+=360,terminatorMesh4=new THREE.Mesh(w,S),terminatorScene.add(terminatorMesh1),terminatorScene.add(terminatorMesh2),terminatorScene.add(terminatorMesh3),terminatorScene.add(terminatorMesh4),stats=new Stats,stats.domElement.id="FPS",stats.domElement.style.position="absolute",stats.domElement.style.bottom="10px",stats.domElement.style.right="30px",stats.domElement.style.zIndex=100,stats.domElement.children[0].children[0].style.color="#666",stats.domElement.children[0].style.background="transparent",stats.domElement.children[0].children[1].style.display="none",container.appendChild(stats.domElement),$(container).mouseup(onDocumentMouseUp),$(container).mousedown(onDocumentMouseDown),$(container).mousemove(onDocumentMouseMove),$(window).mousewheel(onDocumentMouseWheel),$(container).dblclick(onDocumentDoubleClick),$(window).resize(onDocumentWindowResize),$(window).keydown(onKeyDown),recalculateWindow(),gui=new dat.GUI,progressIndicatorControl=gui.add(window,"progressIndicator",0,100),progressIndicatorControl.listen(),progressIndicatorControl.name("Loaded %");var x=gui.addFolder("Display Options");x.add(mapControls,"displayBackground").listen().name("Draw <u>M</u>ap").onChange(function(e){doRedraw=!0}),x.add(mapControls,"drawPlanes").listen().name("Draw <u>P</u>lanes").onChange(function(e){doRedraw=!0}),x.add(mapControls,"drawTracks").listen().name("Draw <u>T</u>racks").onChange(function(e){doRedraw=!0}),x.add(mapControls,"displayClock").listen().name("Display <u>C</u>lock").onChange(function(e){checkClock()}),x.add(mapControls,"wrapMap").listen().name("Wrap Map").onChange(function(e){doRedraw=!0}),x.add(mapControls,"displayNight").listen().name("Draw <u>N</u>ight").onChange(function(e){doRedraw=!0}),x.add(mapControls,"displayHD").listen().name("HD Map (Slow)").onChange(function(e){doRedraw=!0;if(sceneHD==undefined){sceneHD=new THREE.Scene;for(var t=0;t<10;t++)for(var n=0;n<10;n++){var r=new THREE.PlaneGeometry(worldWidth/10,worldHeight/10),i=THREE.ImageUtils.loadTexture("../images/tiles/output_"+n+"_"+t+".png");i.anisotropy=renderer.getMaxAnisotropy();var s=new THREE.MeshBasicMaterial({map:i});s.depthTest=!1;var o=new THREE.Mesh(r,s);o.position.x=t*worldWidth/10-worldWidth/2+worldWidth/20,o.position.y=(9-n)*worldHeight/10-worldHeight/2+worldHeight/20,sceneHD.add(o)}}}),x.add(mapControls,"x",-360,360).listen().name("Latitude").onChange(function(e){doRedraw=!0}),x.add(mapControls,"y",-180,180).listen().name("Longitude").onChange(function(e){doRedraw=!0});var T=x.add(mapControls,"alpha",.008,.3).name("Line Thickness");T.onChange(function(e){doRedraw=!0});var N=x.add(mapControls,"logScale",0,maxZoomLog).name("Zoom");N.onChange(function(e){mapControls.scale=Math.exp(mapControls.logScale)/Math.E,doRedraw=!0}),N.listen();var C=gui.addFolder("Animation Options");C.add(mapControls,"doAnimation").listen().name("<u>A</u>nimate").onChange(function(e){doRedraw=!0,mapControls.doAnimation==1&&(mapControls.drawPlanes=!0)});var k=C.add(mapControls,"startTime",0,86473).listen();k.onChange(function(e){doRedraw=!0});var L=C.add(mapControls,"timeStep",-200,400).name("Speed").listen();C.add(mapControls,"contrailLength",0,7200).onChange(function(e){doRedraw=!0});var A=gui.addFolder("Filter Options"),O=A.add(mapControls,"far",0,6e4).listen();O.onChange(function(e){mapControls.far>mapControls.near&&(mapControls.near=mapControls.far),doRedraw=!0}),O.name("Show Above");var M=A.add(mapControls,"near",1,6e4).listen();M.onChange(function(e){mapControls.far>mapControls.near&&(mapControls.far=mapControls.near),doRedraw=!0}),M.name("Show Below");var _=new XMLHttpRequest,D="../data/Sept29.binflight",P=0;_.onprogress=function(e){doRedraw=!0,console.log(_);var t=_.response;if(e.lengthComputable)progressIndicator=e.loaded/e.total*100;else{var n=0;_.response!=undefined&&_.response!=null&&(n=_.response.byteLength);if(n==undefined||n==0)n=72e6;progressIndicator=e.loaded/n*100}},_.onreadystatechange=function(){if(_.readyState==4)if(_.status==200||_.status==0){var e=_.response;e===undefined&&(e=(new Uint8Array(_.responseBody)).buffer),$("#loading-screen").hide(),process_the_array_buffer(e)}else console.error("THREE.BinaryLoader: Couldn't load ["+D+"] ["+_.status+"]");else _.readyState!=3&&_.readyState==2&&(P=_.getResponseHeader("Content-Length"))},_.open("GET",D,!0),_.responseType="arraybuffer",_.send(null),gl=renderer.getContext(),webGLStart(),document.cancelFullScreen=document.webkitCancelFullScreen||document.mozCancelFullScreen,container.addEventListener("webkitfullscreenchange",fullscreenchange,!1),container.addEventListener("mozfullscreenchange",fullscreenchange,!1),doRedraw=!0}function process_the_array_buffer(e){flightsData=e,numFlights=0,dataView=new DataView(e),dataLength=dataView.byteLength,dataOffset=0,console.log("Parsing Start"),flightsLoaded=!0,flightsNeedProcessing=!0,progressIndicatorControl.name("Processed %"),mapControls.displayClock=!0,checkClock()}function getUTF8String(){var e="",t=dataView.getInt16(dataOffset);dataOffset+=2;for(var n=0;n<t;++n){var r=dataView.getUint8(dataOffset+n);e+=String.fromCharCode(r)}return dataOffset+=t,e}function skipUTF8String(){var e=dataView.getInt16(dataOffset);dataOffset+=e+2}function addGreatCirclePoints(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=haversineDistanceKM(t,e,o,s),d=!1,v;if(p>500){var v=midpoint({x:e,y:t},{x:s,y:o}),m=Math.abs(Math.atan2(v.x-e,v.y-t)-Math.atan2(s-v.x,o-v.y));m>Math.PI&&(m=2*Math.PI-m),m>Math.PI*5/180&&(d=!0)}if(!d)return e<0&&s>0&&s-e>180?s-=360:e>0&&s<0&&e-s>180&&(s+=360),l[h*8+0]=e,l[h*8+1]=t,l[h*8+2]=n,l[h*8+3]=i,l[h*8+5]=o,l[h*8+4]=s,l[h*8+6]=u,l[h*8+7]=f,currentVertexListPosition+=32,1;extraSegments++;var g=(n+n)/2,y=(i+f)/2,b=addGreatCirclePoints(e,t,n,r,i,v.x,v.y,g,r,y,l,c,h),w=addGreatCirclePoints(v.x,v.y,g,a,y,s,o,u,a,f,l,c,h+b);return b+w}function reallyProcess(){if(!flightsNeedProcessing)return;var e=numProcessPerFrame;while(dataOffset<dataLength&&e>0){e--;var t={key:getUTF8String(),origin:getUTF8String(),destination:getUTF8String(),flight:skipUTF8String(),radar:skipUTF8String(),squawk:skipUTF8String(),debug:dataView.getInt32(dataOffset),numPoints:dataView.getInt32(dataOffset+4),rendered:!1};dataOffset+=8;var n=(t.numPoints-1)*2*4+800,r=getVertexListFor(n);currentVertexListPosition-=n*4;var i=new Float32Array(vertexLists[currentVertexList],r),s=new Uint32Array(vertexLists[currentVertexList],r),o=0;for(var u=0;u<t.numPoints-1;u++){var a=dataView.getFloat32(dataOffset+4),f=dataView.getFloat32(dataOffset+20),l=dataView.getFloat32(dataOffset+0),c=dataView.getFloat32(dataOffset+16),h=dataView.getInt32(dataOffset+8),p=dataView.getInt32(dataOffset+24),d=h&65535,v=p&65535,m=h>>16,g=p>>16,y=dataView.getInt32(dataOffset+12),b=dataView.getInt32(dataOffset+28);y-=baseTime,b-=baseTime,g&1&&(f=a,c=l);if(g&2){var w=addGreatCirclePoints(a,l,d,m,y,f,c,v,g,b,i,s,o);o+=w}else a<0&&f>0&&f-a>180?f-=360:a>0&&f<0&&a-f>180&&(f+=360),i[o*8+0]=a,i[o*8+1]=l,i[o*8+2]=d,i[o*8+3]=y,i[o*8+5]=c,i[o*8+4]=f,i[o*8+6]=v,i[o*8+7]=b,o++,currentVertexListPosition+=32;dataOffset+=16}dataOffset+=16,flights[t.key]=t,numFlights++}progressIndicator=100*dataOffset/dataLength,dataOffset>=dataLength&&(flightsNeedProcessing=!1,finalizeVertexList(),console.log("DONE Adding flights to scene"),console.log("Extra Segments = "+extraSegments))}function fullscreenchange(){document.webkitIsFullScreen||document.mozFullScreen?(inFullScreen=!0,console.log(" set to true")):(inFullScreen=!1,console.log(" set to false")),doRedraw=!0}function ToggleFullScreen(){inFullScreen?(console.log("EXIT Full screen"),document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),inFullScreen=!1):(console.log("ENTERING Full screen"),container.requestFullscreen?(console.log("requestFullscreen"),container.requestFullscreen(),inFullScreen=!0):container.webkitRequestFullScreen?(console.log("webkitRequestFullScreen"),container.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT),inFullScreen=!0):container.mozRequestFullScreen&&(console.log("mozRequestFullScreen"),container.mozRequestFullScreen(),inFullScreen=!0))}function onKeyDown(e){console.log(e.keyCode);switch(e.keyCode){case 32:case 65:mapControls.doAnimation=!mapControls.doAnimation,mapControls.doAnimation==1&&(mapControls.drawPlanes=!0),doRedraw=!0;break;case 77:mapControls.displayBackground=!mapControls.displayBackground,doRedraw=!0;break;case 84:mapControls.drawTracks=!mapControls.drawTracks,doRedraw=!0;break;case 80:mapControls.drawPlanes=!mapControls.drawPlanes,doRedraw=!0;break;case 70:console.log("Attempting toggley full screen"),ToggleFullScreen();break;case 72:case 83:$("#info").is(":visible")?($("#info").hide(),$("#FPS").hide()):($("#info").show(),$("#FPS").show());break;case 67:mapControls.displayClock=!mapControls.displayClock,checkClock();break;case 78:mapControls.displayNight=!mapControls.displayNight,doRedraw=!0;break;case 80:}}function checkClock(){mapControls.displayClock?$("#time").show():$("#time").hide()}function onDocumentMouseWheel(e,t,n,r){var i=mapControls.scale*=1+r*zoomSpeed;i<minZoom&&(i=minZoom),i>maxZoom&&(i=maxZoom),mapControls.scale=i,mapControls.logScale=Math.log(mapControls.scale*Math.E),recalculateWindow(null),doRedraw=!0}function onDocumentDoubleClick(e){var t=PixelsToWorld(e.clientX,e.clientY);mapControls.x=t.x,mapControls.y=t.y;var n=mapControls.scale*6;n<minZoom&&(n=minZoom),n>maxZoom&&(n=maxZoom),mapControls.scale=n,mapControls.logScale=Math.log(mapControls.scale*Math.E),recalculateWindow(null),doRedraw=!0}function onDocumentMouseDown(e){lastMouseEvent.x=e.clientX,lastMouseEvent.y=e.clientY,mouseDown=!0}function onDocumentMouseUp(e){lastMouseEvent.x=e.clientX,lastMouseEvent.y=e.clientY,mouseDown=!1}function onDocumentMouseMove(e){mouseDown&&(mapControls.x-=(e.clientX-lastMouseEvent.x)/mapControls.scale*worldWidth/SCREEN_WIDTH,mapControls.y+=(e.clientY-lastMouseEvent.y)/mapControls.scale*worldWidth/SCREEN_WIDTH,doRedraw=!0),lastMouseEvent.x=e.clientX,lastMouseEvent.y=e.clientY}function onDocumentWindowResize(){doRedraw=!0}function recalculateWindow(){SCREEN_WIDTH=window.innerWidth,SCREEN_HEIGHT=window.innerHeight,mapControls.x<-worldWidth/2&&(mapControls.x+=worldWidth),mapControls.x>worldWidth/2&&(mapControls.x-=worldWidth),camera2D.near=1e4,camera2D.far=-150;var e=mapControls.scale;return renderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT),camera2D.position.x=mapControls.x,camera2D.position.y=mapControls.y,camera2D.left=-worldWidth/2/e,camera2D.right=worldWidth/2/e,camera2D.top=worldWidth/2/e*SCREEN_HEIGHT/SCREEN_WIDTH,camera2D.bottom=-worldWidth/2/e*SCREEN_HEIGHT/SCREEN_WIDTH,camera2D.updateProjectionMatrix(),!1}function animate(){requestAnimationFrame(animate),render(),stats.update()}function render(){flightsNeedProcessing&&reallyProcess();var e=baseTime+mapControls.startTime,t=new Date(e*1e3);$("#time").html(t.toString("hh:mm"));var n=new Date((baseTime+mapControls.startTime)*1e3),r=n.getUTCHours()*3600+n.getUTCMinutes()*60+n.getUTCSeconds(),i=r/86400;terminatorMesh1.position.x=180-360*i,terminatorMesh2.position.x=180-360*i+360,terminatorMesh3.position.x=180-360*i+720,terminatorMesh4.position.x=180-360*i-360,doRedraw&&(mapControls.doAnimation?(mapControls.startTime+=mapControls.timeStep,mapControls.startTime>86473&&(mapControls.startTime=mapControls.contrailLength),mapControls.startTime<0&&(mapControls.startTime=86473)):doRedraw=!1,recalculateWindow(null),tripleRender(function(){mapControls.displayBackground&&(mapControls.displayHD&&mapControls.scale>2?renderer.render(sceneHD,camera2D):renderer.render(scene,camera2D))}),mapControls.displayNight&&renderer.render(terminatorScene,camera2D),tripleRender(function(){mapControls.drawTracks&&drawScene(!1)}),tripleRender(function(){mapControls.drawPlanes&&drawScene(!0)}))}function tripleRender(e){camera2D.position.x=mapControls.x,camera2D.position.y=mapControls.y,renderer.setViewport(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),e(),mapControls.wrapMap&&(camera2D.position.x+camera2D.right>worldWidth/2&&(camera2D.position.x-=worldWidth,e(),camera2D.position.x+=worldWidth),camera2D.position.x+camera2D.left<-worldWidth/2&&(camera2D.position.x+=worldWidth,e(),camera2D.position.x-=worldWidth))}function renderStuff(e){mapControls.displayBackground&&(renderer.render(scene,camera2D),e&&renderer.render(terminatorScene,camera2D)),mapControls.drawTracks&&drawScene(!1),mapControls.drawPlanes&&drawScene(!0)}function initGL(e){try{gl=e.getContext("experimental-webgl"),gl.viewportWidth=e.width,gl.viewportHeight=e.height}catch(t){}gl||alert("Could not initialise WebGL, sorry :-(")}function getShader(e,t){var n=document.getElementById(t);if(!n)return null;var r="",i=n.firstChild;while(i)i.nodeType==3&&(r+=i.textContent),i=i.nextSibling;var s;if(n.type=="x-shader/x-fragment")s=e.createShader(e.FRAGMENT_SHADER);else{if(n.type!="x-shader/x-vertex")return null;s=e.createShader(e.VERTEX_SHADER)}return e.shaderSource(s,r),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)?s:(alert(e.getShaderInfoLog(s)),null)}function CustomShader(e,t){this.fragmentShader=getShader(gl,e),this.vertexShader=getShader(gl,t),this.shaderProgram=gl.createProgram(),gl.attachShader(this.shaderProgram,this.vertexShader),gl.attachShader(this.shaderProgram,this.fragmentShader),gl.linkProgram(this.shaderProgram),gl.getProgramParameter(this.shaderProgram,gl.LINK_STATUS)||alert("Could not initialise shaders "+e+" "+t),gl.useProgram(this.shaderProgram),this.addAttrib=function(e){this[e]=gl.getAttribLocation(this.shaderProgram,e)},this.addUniform=function(e){this[e]=gl.getUniformLocation(this.shaderProgram,e)},this.addVarying=function(e){this[e]=gl.getUniformLocation(this.shaderProgram,e)},this.addVertexArray=function(e){this.addAttrib(e),gl.enableVertexAttribArray(this.shaderProgram[e])},this.use=function(){gl.useProgram(this.shaderProgram)}}function initShaders(){var e=getShader(gl,"shader-fs-anim");shaderProgram=new CustomShader("shader-vs","shader-fs"),shaderProgram.addVertexArray("aVertexPosition"),shaderProgram.addUniform("uPMatrix"),shaderProgram.addUniform("uVertexColor"),shaderProgramAnim=new CustomShader("shader-vs","shader-fs-anim"),shaderProgramAnim.addUniform("startTime"),shaderProgramAnim.addUniform("endTime"),shaderProgramAnim.addUniform("uPMatrix"),shaderProgramAnim.addUniform("uVertexColor"),shaderProgramAnim.addVertexArray("aVertexPosition")}function initBuffers(){}function drawScene(e){var t;if(e){t=shaderProgramAnim,t.use();var n=mapControls.startTime,r=n-mapControls.contrailLength;r<0&&(r=0),n==0&&(n=100),gl.uniform1f(t.startTime,r),gl.uniform1f(t.endTime,n),gl.uniform4f(t.uVertexColor,1,1,1,mapControls.alpha)}else t=shaderProgram,t.use(),gl.uniform4f(t.uVertexColor,0,0,1,mapControls.alpha);gl.viewport(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),mat4.ortho(camera2D.left+camera2D.position.x,camera2D.right+camera2D.position.x,camera2D.bottom+camera2D.position.y,camera2D.top+camera2D.position.y,mapControls.near,mapControls.far,pMatrix),gl.uniformMatrix4fv(t.uPMatrix,!1,pMatrix),gl.disable(gl.DEPTH_TEST);for(var i=0;i<currentVertexList;i++){var s=vertexListGLBuffers[i];gl.bindBuffer(gl.ARRAY_BUFFER,s),gl.vertexAttribPointer(t.aVertexPosition,4,gl.FLOAT,!1,0,0),gl.drawArrays(gl.LINES,0,vertexListGLBuffers[i].numItems/4)}}function webGLStart(){mvMatrix=mat4.create(),pMatrix=mat4.create(),gl.viewportWidth=SCREEN_WIDTH,gl.viewportHeight=SCREEN_HEIGHT,initShaders(),initBuffers(),gl.clearColor(0,0,0,1),gl.enable(gl.DEPTH_TEST)}var SCREEN_WIDTH=window.innerWidth,SCREEN_HEIGHT=window.innerHeight,container,stats,camera,scene,sceneHD,renderer,mesh,camera2D,minZoom=.5,maxZoomLog=12,maxZoom=Math.exp(maxZoomLog)/Math.E,worldWidth=360,worldHeight=180,earthRadiusKM=6371,progressIndicator=0,progressIndicatorControl=0,doRedraw=!0,baseTime=1348940147,terminatorMesh1,terminatorMesh2,terminatorMesh3,terminatorMesh4,terminatorScene,mouseDown=!1,lastMouseEvent={x:0,y:0},mapControls={logScale:1,scale:1,x:0,y:0,alpha:.1,near:6e4,far:0,displayBackground:!0,wrapMap:!0,startTime:2e3,timeStep:30,doAnimation:!0,drawPlanes:!0,drawTracks:!1,displayClock:!1,contrailLength:800,displayNight:!1,displayHD:!1},zoomSpeed=.2,vertexLists=new Array,vertexListSizes=new Array,vertexListGLBuffers=new Array,vertexListSize=1e6,currentVertexList=-1,currentVertexListPosition=-1;init(),animate();var gui;$(document).ready(function(){}),jDataView.prototype.getUTF8String=function(){var e=this.getInt16();return this.getString(e)};var flights={},flightsLoaded=!1,flightsNeedProcessing=!1,flightsData,numProcessPerFrame=5e3,dataView,dataOffset,dataLength,numFlights,extraSegments=0,inFullScreen=!1,gl,shaderProgram,shaderProgramAnim,pMatrix;